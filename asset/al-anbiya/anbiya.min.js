/**
 * Surah Al-Anbiya Interactive Reader Tool
 * ¬© 2024 IlmuAlam.com - All Rights Reserved
 * License: MIT (for hosting on GitHub CDN)
 * Author: IlmuAlam Development Team
 * Version: 2.0.0
 * 
 * Features:
 * - Audio playback per verse with multiple qari options
 * - Rumi transliteration display
 * - Malay translation
 * - Auto-scroll and verse highlighting
 * - Bookmark system with localStorage
 * - Search functionality
 * - Dark mode toggle
 * - Responsive mobile-first design
 * 
 * API: Al-Quran Cloud API (https://alquran.cloud/api)
 * 
 * Dependencies: None (Vanilla JS)
 */

(function() {
    'use strict';
    
    // Configuration
    const CONFIG = {
        surahNumber: 21,
        surahName: 'Al-Anbiya',
        surahNameArabic: 'ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°',
        totalVerses: 112,
        apiBase: 'https://api.alquran.cloud/v1',
        qariOptions: [
            { id: 'ar.alafasy', name: 'Mishary Alafasy', lang: 'ar' },
            { id: 'ar.husary', name: 'Mahmoud Khalil Al-Husary', lang: 'ar' },
            { id: 'ar.abdulbasitmurattal', name: 'Abdul Basit (Murattal)', lang: 'ar' }
        ],
        colors: {
            primary: '#249749',
            primaryDark: '#0c3808',
            lightBg: '#f8fdf9',
            cardBg: '#ffffff'
        }
    };

    // State Management
    let state = {
        verses: [],
        currentVerse: null,
        isPlaying: false,
        selectedQari: CONFIG.qariOptions[0],
        darkMode: false,
        bookmarks: [],
        searchQuery: '',
        audio: null
    };

    // Initialize
    function init() {
        if (!document.getElementById('ilm-x-reader-tool')) {
            console.error('IlmuAlam Tool: Container #ilm-x-reader-tool not found');
            return;
        }
        
        loadState();
        renderUI();
        fetchSurahData();
        attachEventListeners();
    }

    // Load state from localStorage
    function loadState() {
        try {
            const saved = localStorage.getItem('ilm_surah_21_bookmarks');
            if (saved) {
                state.bookmarks = JSON.parse(saved);
            }
            const darkMode = localStorage.getItem('ilm_dark_mode');
            if (darkMode === 'true') {
                state.darkMode = true;
                document.body.classList.add('ilm-x-dark-mode');
            }
        } catch (e) {
            console.warn('Error loading state:', e);
        }
    }

    // Save bookmarks
    function saveBookmarks() {
        try {
            localStorage.setItem('ilm_surah_21_bookmarks', JSON.stringify(state.bookmarks));
        } catch (e) {
            console.warn('Error saving bookmarks:', e);
        }
    }

    // Fetch Surah Data
    async function fetchSurahData() {
        try {
            showLoader();
            
            // Fetch Arabic, Rumi, and Malay in parallel
            const [arabic, malay] = await Promise.all([
                fetch(`${CONFIG.apiBase}/surah/${CONFIG.surahNumber}`).then(r => r.json()),
                fetch(`${CONFIG.apiBase}/surah/${CONFIG.surahNumber}/ms.basmeih`).then(r => r.json())
            ]);

            if (arabic.data && malay.data) {
                state.verses = arabic.data.ayahs.map((ayah, index) => ({
                    number: ayah.numberInSurah,
                    numberInQuran: ayah.number,
                    arabic: ayah.text,
                    rumi: generateRumi(ayah.text), // Simplified rumi generation
                    translation: malay.data.ayahs[index].text,
                    audio: `https://cdn.islamic.network/quran/audio/128/${state.selectedQari.id}/${ayah.number}.mp3`,
                    juz: ayah.juz,
                    page: ayah.page
                }));
                
                renderVerses();
            } else {
                showError('Gagal memuatkan data surah. Sila cuba sebentar lagi.');
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            showError('Ralat sambungan. Periksa sambungan internet anda.');
        } finally {
            hideLoader();
        }
    }

    // Simple Rumi generation (basic transliteration)
    function generateRumi(arabic) {
        // This is a simplified version. For production, use proper transliteration API
        const rumiMap = {
            'ÿß': 'a', 'ÿ®': 'b', 'ÿ™': 't', 'ÿ´': 'ts', 'ÿ¨': 'j', 'ÿ≠': 'h', 'ÿÆ': 'kh',
            'ÿØ': 'd', 'ÿ∞': 'dz', 'ÿ±': 'r', 'ÿ≤': 'z', 'ÿ≥': 's', 'ÿ¥': 'sy', 'ÿµ': 'sh',
            'ÿ∂': 'dh', 'ÿ∑': 'th', 'ÿ∏': 'zh', 'ÿπ': '\'', 'ÿ∫': 'gh', 'ŸÅ': 'f', 'ŸÇ': 'q',
            'ŸÉ': 'k', 'ŸÑ': 'l', 'ŸÖ': 'm', 'ŸÜ': 'n', 'Ÿá': 'h', 'Ÿà': 'w', 'Ÿä': 'y',
            'Ÿé': 'a', 'Ÿê': 'i', 'Ÿè': 'u', 'Ÿí': '', 'Ÿë': '', 'Ÿã': 'an', 'Ÿç': 'in', 'Ÿå': 'un'
        };
        
        let rumi = '';
        for (let char of arabic) {
            rumi += rumiMap[char] || char;
        }
        return rumi.trim();
    }

    // UI Rendering
    function renderUI() {
        const container = document.getElementById('ilm-x-reader-tool');
        container.innerHTML = `
            <div class="ilm-x-tool-wrapper" id="ilm-x-tool-${CONFIG.surahNumber}">
                ${renderStyles()}
                <div class="ilm-x-tool-header">
                    <div class="ilm-x-tool-title">
                        <h2>üéß Tool Bacaan Surah ${CONFIG.surahName}</h2>
                        <p>Bacaan Interaktif ‚Ä¢ Audio Per Ayat ‚Ä¢ Rumi ‚Ä¢ Terjemahan</p>
                    </div>
                    <div class="ilm-x-tool-controls">
                        <button id="ilm-x-dark-toggle" class="ilm-x-icon-btn" title="Mode Gelap">
                            üåô
                        </button>
                    </div>
                </div>

                <div class="ilm-x-tool-options">
                    <div class="ilm-x-option-group">
                        <label>Pilih Qari:</label>
                        <select id="ilm-x-qari-select" class="ilm-x-select">
                            ${CONFIG.qariOptions.map(q => 
                                `<option value="${q.id}">${q.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="ilm-x-option-group">
                        <input type="text" id="ilm-x-search" placeholder="Cari ayat..." class="ilm-x-input">
                    </div>
                </div>

                <div id="ilm-x-loader" class="ilm-x-loader">
                    <div class="ilm-x-spinner"></div>
                    <p>Memuatkan Surah ${CONFIG.surahName}...</p>
                </div>

                <div id="ilm-x-error" class="ilm-x-error" style="display:none;"></div>

                <div id="ilm-x-verses-container" class="ilm-x-verses-container"></div>

                <div class="ilm-x-tool-footer">
                    <p>¬© ${new Date().getFullYear()} IlmuAlam.com ‚Ä¢ Data: Al-Quran Cloud API</p>
                </div>
            </div>
        `;
    }

    // Render Styles (Inline CSS < 6KB)
    function renderStyles() {
        return `
            <style>
                .ilm-x-tool-wrapper{max-width:900px;margin:32px auto;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.08);overflow:hidden}
                .ilm-x-tool-header{background:linear-gradient(135deg,#249749 0%,#1a7038 100%);color:#fff;padding:24px;text-align:center}
                .ilm-x-tool-header h2{font-size:clamp(20px,4vw,28px);margin-bottom:8px}
                .ilm-x-tool-header p{opacity:0.9;font-size:14px}
                .ilm-x-tool-options{display:flex;gap:16px;padding:20px;background:#f8fdf9;flex-wrap:wrap}
                .ilm-x-option-group{flex:1;min-width:200px}
                .ilm-x-option-group label{display:block;margin-bottom:6px;font-weight:600;color:#0c3808;font-size:14px}
                .ilm-x-select,.ilm-x-input{width:100%;padding:10px 14px;border:2px solid #e8f5ee;border-radius:8px;font-size:15px;transition:border-color 0.2s}
                .ilm-x-select:focus,.ilm-x-input:focus{outline:none;border-color:#249749}
                .ilm-x-icon-btn{display:inline-block!important;visibility:visible!important;opacity:1!important;appearance:button!important;background:#fff!important;border:2px solid #fff!important;border-radius:8px!important;padding:8px 12px!important;cursor:pointer!important;font-size:20px!important;transition:transform 0.2s!important}
                .ilm-x-icon-btn:hover{transform:scale(1.1)!important}
                .ilm-x-loader{text-align:center;padding:60px 20px}
                .ilm-x-spinner{width:50px;height:50px;border:4px solid #e8f5ee;border-top-color:#249749;border-radius:50%;margin:0 auto 16px;animation:ilm-spin 1s linear infinite}
                @keyframes ilm-spin{to{transform:rotate(360deg)}}
                .ilm-x-error{background:#ffebee;color:#c62828;padding:16px;margin:16px;border-radius:8px;border-left:4px solid #c62828}
                .ilm-x-verses-container{padding:20px}
                .ilm-x-verse{background:#f8fdf9;border:2px solid #e8f5ee;border-radius:12px;padding:20px;margin-bottom:16px;transition:all 0.3s}
                .ilm-x-verse:hover{border-color:#249749;box-shadow:0 4px 12px rgba(36,151,73,0.1)}
                .ilm-x-verse.active{border-color:#249749;background:#f0f9f4}
                .ilm-x-verse-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #e8f5ee}
                .ilm-x-verse-number{background:#249749;color:#fff;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
                .ilm-x-verse-actions{display:flex;gap:8px}
                .ilm-x-btn-small{display:inline-block!important;visibility:visible!important;opacity:1!important;appearance:button!important;background:#fff!important;border:2px solid #249749!important;color:#249749!important;padding:6px 12px!important;border-radius:6px!important;font-size:13px!important;cursor:pointer!important;transition:all 0.2s!important}
                .ilm-x-btn-small:hover{background:#249749!important;color:#fff!important}
                .ilm-x-verse-arabic{font-family:'Traditional Arabic','Arial',sans-serif;font-size:clamp(22px,4vw,28px);line-height:1.8;text-align:right;color:#0c3808;margin-bottom:12px;direction:rtl}
                .ilm-x-verse-rumi{font-size:15px;color:#555;font-style:italic;margin-bottom:10px;line-height:1.6}
                .ilm-x-verse-translation{font-size:16px;color:#0c3808;line-height:1.7}
                .ilm-x-bookmark{background:#ffd700!important;border-color:#ffd700!important}
                .ilm-x-tool-footer{background:#f8fdf9;padding:16px;text-align:center;font-size:13px;color:#666;border-top:2px solid #e8f5ee}
                .ilm-x-dark-mode .ilm-x-tool-wrapper{background:#1a1a1a;color:#e0e0e0}
                .ilm-x-dark-mode .ilm-x-verse{background:#2a2a2a;border-color:#3a3a3a}
                .ilm-x-dark-mode .ilm-x-verse-arabic,.ilm-x-dark-mode .ilm-x-verse-translation{color:#e0e0e0}
                .ilm-x-dark-mode .ilm-x-verse-rumi{color:#aaa}
                @media (max-width:640px){
                    .ilm-x-tool-options{flex-direction:column}
                    .ilm-x-verse{padding:16px}
                    .ilm-x-verse-arabic{font-size:20px}
                }
            </style>
        `;
    }

    // Render Verses
    function renderVerses() {
        const container = document.getElementById('ilm-x-verses-container');
        const filteredVerses = state.searchQuery 
            ? state.verses.filter(v => 
                v.arabic.includes(state.searchQuery) || 
                v.translation.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                v.rumi.toLowerCase().includes(state.searchQuery.toLowerCase())
            )
            : state.verses;

        container.innerHTML = filteredVerses.map(verse => `
            <div class="ilm-x-verse ${state.bookmarks.includes(verse.number) ? 'ilm-x-bookmark' : ''}" 
                 id="ilm-x-verse-${verse.number}" 
                 data-verse="${verse.number}">
                <div class="ilm-x-verse-header">
                    <div class="ilm-x-verse-number">${verse.number}</div>
                    <div class="ilm-x-verse-actions">
                        <button class="ilm-x-btn-small ilm-x-play-btn" data-verse="${verse.number}" 
                                style="display:inline-block!important;visibility:visible!important;opacity:1!important;">
                            ‚ñ∂Ô∏è Main
                        </button>
                        <button class="ilm-x-btn-small ilm-x-bookmark-btn ${state.bookmarks.includes(verse.number) ? 'ilm-x-bookmark' : ''}" 
                                data-verse="${verse.number}"
                                style="display:inline-block!important;visibility:visible!important;opacity:1!important;">
                            ${state.bookmarks.includes(verse.number) ? '‚≠ê' : '‚òÜ'}
                        </button>
                    </div>
                </div>
                <div class="ilm-x-verse-arabic">${verse.arabic}</div>
                <div class="ilm-x-verse-rumi">${verse.rumi}</div>
                <div class="ilm-x-verse-translation">${verse.translation}</div>
            </div>
        `).join('');

        attachVerseEventListeners();
    }

    // Event Listeners
    function attachEventListeners() {
        // Dark mode toggle
        document.getElementById('ilm-x-dark-toggle')?.addEventListener('click', toggleDarkMode);

        // Qari selection
        document.getElementById('ilm-x-qari-select')?.addEventListener('change', (e) => {
            state.selectedQari = CONFIG.qariOptions.find(q => q.id === e.target.value);
            updateAudioSources();
        });

        // Search
        document.getElementById('ilm-x-search')?.addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            renderVerses();
        });
    }

    function attachVerseEventListeners() {
        // Play buttons
        document.querySelectorAll('.ilm-x-play-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const verseNum = parseInt(e.target.dataset.verse);
                playVerse(verseNum);
            });
        });

        // Bookmark buttons
        document.querySelectorAll('.ilm-x-bookmark-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const verseNum = parseInt(e.target.dataset.verse);
                toggleBookmark(verseNum);
            });
        });
    }

    // Audio Controls
    function playVerse(verseNum) {
        const verse = state.verses.find(v => v.number === verseNum);
        if (!verse) return;

        // Stop current audio
        if (state.audio) {
            state.audio.pause();
            state.audio = null;
        }

        // Remove previous highlights
        document.querySelectorAll('.ilm-x-verse').forEach(v => v.classList.remove('active'));

        // Highlight current verse
        const verseEl = document.getElementById(`ilm-x-verse-${verseNum}`);
        verseEl?.classList.add('active');
        verseEl?.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Play audio
        state.audio = new Audio(verse.audio);
        state.audio.play().catch(err => {
            console.error('Audio playback error:', err);
            showError('Ralat memainkan audio. Cuba sekali lagi.');
        });

        state.audio.onended = () => {
            verseEl?.classList.remove('active');
            // Auto-play next verse
            if (verseNum < CONFIG.totalVerses) {
                setTimeout(() => playVerse(verseNum + 1), 500);
            }
        };

        state.currentVerse = verseNum;
        state.isPlaying = true;
    }

    function updateAudioSources() {
        state.verses.forEach(verse => {
            verse.audio = `https://cdn.islamic.network/quran/audio/128/${state.selectedQari.id}/${verse.numberInQuran}.mp3`;
        });
    }

    // Bookmark Management
    function toggleBookmark(verseNum) {
        const index = state.bookmarks.indexOf(verseNum);
        if (index > -1) {
            state.bookmarks.splice(index, 1);
        } else {
            state.bookmarks.push(verseNum);
        }
        saveBookmarks();
        renderVerses();
    }

    // Dark Mode
    function toggleDarkMode() {
        state.darkMode = !state.darkMode;
        document.body.classList.toggle('ilm-x-dark-mode');
        localStorage.setItem('ilm_dark_mode', state.darkMode);
    }

    // UI Helpers
    function showLoader() {
        const loader = document.getElementById('ilm-x-loader');
        if (loader) loader.style.display = 'block';
    }

    function hideLoader() {
        const loader = document.getElementById('ilm-x-loader');
        if (loader) loader.style.display = 'none';
    }

    function showError(message) {
        const errorEl = document.getElementById('ilm-x-error');
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    }

    // Auto-initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
